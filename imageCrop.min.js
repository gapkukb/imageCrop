"use strict";function _readOnlyError(t){throw new Error('"'+t+'" is read-only')}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}!function(t,e){var i="function"==typeof define,s="undefined"!=typeof module&&module.exports;i?define(e):s?module.exports=e():this.ImageCrop=e()}(0,function(){var t=window.navigator.userAgent.includes("Mobile"),s={begin:t?"ontouchstart":"onmousedown",move:t?"ontouchmove":"onmousemove",end:t?"ontouchend":"onmouseup"},i=function(t){return document.querySelector(t)},c=function(t){var e="base64,",i=(t=t.substring(t.indexOf(e)+e.length)).indexOf("=");-1!==i&&(t=t.substring(0,i));var s=t.length;return Math.ceil(s-s/8*2)};return function(){function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(_classCallCheck(this,e),this.el=i(t.el),this.inputFile=i(t.inputFile),!this.el||!this.inputFile)throw Error("the el element or fileInput element not define");this.previewBox=i(t.preview)||document.createElement("input"),this.previewBox.type="hidden",this.isCircle=t.circle||!1,this.alert=t.alert,this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.entry=Object.assign({fileTypes:["jpeg","png","gif","bmp","svg","webp"],size:524288e4,width:"60%",height:"60%",minWidth:60,minHeight:60,keepRatio:!0},t.entry),this.entry.fileTypes=this.entry.fileTypes.map(function(t){return"image/"+("svg"===t?"svg+xml":t)}),this.inputFile.accept=this.entry.fileTypes.join(","),this.output=Object.assign({fileType:"jpeg",imagePrefix:"unkown",width:0,blob:!0,quality:1},t.output),this.keep=this.entry.keepRatio,this._circle=this.circle,this.tools=null,this.preview=null,this.image=null,this.copy=null,this.circle=null,this.svg=null,this.cf=this.previewBox.offsetWidth/this.width,this.ratio=0,this.props={x:0,y:0,w:0,h:0,ix:0,iy:0},this.ok=!1,this.bindFileChange()}return _createClass(e,[{key:"getCroped",value:function(){var t=this.image.naturalWidth/this.width,h=document.createElement("canvas"),e=h.getContext("2d"),i=this.props,s=i.x,o=i.y,n=i.w,r=i.h,a=i.ix,l=i.iy,p=this.output;return h.width=p.width||n*t,h.height=r/n*p.width||r*t,e.fillStyle="#fff","jpeg"===p.fileType&&e.fillRect(0,0,h.width,h.height),this.isCircle&&(e.arc(h.width/2,h.height/2,h.height/2,0,2*Math.PI),e.clip()),e.drawImage(this.image,(s-a)*t,(o-l)*t,n*t,r*t,0,0,h.width,h.height),new Promise(function(e){var t="image/"+p.fileType,i=p.imagePrefix+"."+t.replace("image/","");if(p.blob)h.toBlob(function(t){return e(Object.assign(t,{url:URL.createObjectURL(t),name:i}))},t,p.quality);else{var s=h.toDataURL(t,p.quality);e({size:c(s),url:s,name:i,type:t}),s=null}}).catch(function(t){return console.error(t)})}},{key:"bindFileChange",value:function(){var i=this;this._createElements(),this.inputFile.onchange=function(t){i.ok=!1;var e=i.inputFile.files[0];return i.inputFile.value="",e.size>i.entry.size?(i.alert||window.alert)("文件不得大于"+Math.ceil(i.entry.size/1e3)+"KB"):i.entry.fileTypes.includes(e.type)?void i.update(window.URL.createObjectURL(e)):(i.alert||window.alert)("不支持的文件格式")}}},{key:"adjustDms",value:function(t){var n=this;(t=t||window.event).stopPropagation(),t.preventDefault();var r=t.pageX||t.touches[0].pageX,a=t.pageY||t.touches[0].pageY,l="svg"!==t.target.nodeName.toLowerCase(),e=this.props,p=e.x,c=e.y,d=e.w,u=e.h;document[s.move]=function(t){(t=t||window.event).preventDefault();var e=(t.pageX||t.touches[0].pageX)-r,i=(t.pageY||t.touches[0].pageY)-a;if(l)p=n.props.x+e,c=n.props.y+i;else{if(n.entry.keepRatio){var s=Math.max(e,i),h=n.props.w+s*(i<e?1:n.ratio),o=n.props.h+s/(i<e?n.ratio:1);if(h>n.width||o>n.height||h<n.entry.minWidth||o<n.entry.minHeight)return;d=h,u=o}else d=n.props.w+e,u=n.props.h+i,d=d>n.width?n.width:d<n.entry.minWidth?n.entry.minWidth:d,u=u>n.height?n.height:u<n.entry.minHeight?n.entry.minHeight:u;n.tools.style.width=d+"px",n.tools.style.height=u+"px",p=n.props.x-(d-n.props.w)/2,c=n.props.y-(u-n.props.h)/2}p=p<0?0:p>n.width-d?n.width-d:p,c=c<0?0:c>n.height-u?n.height-u:c,n.tools.style.transform="translate3d(".concat(p,"px,").concat(c,"px,0px)")},document[s.end]=function(){document[s.move]=document[s.end]=null,n.props.w=d,n.props.h=u,n.props.x=p,n.props.y=c,n.previewCb()}}},{key:"previewCb",value:function(){var t=this.props,e=t.x,i=t.y,s=t.w,h=t.h,o=(t.scale,t.rotate,this.cf);this.preview.style.width="".concat(s*o,"px"),this.preview.style.height="".concat(h*o,"px");var n=this.previewBox.offsetWidth/(s*o),r=this.previewBox.offsetHeight/(h*o);this.preview.style.transform="scale(".concat(r<n?r:n,")"),this.copy.style.transform="translate3d(".concat(((this.width-this.image.width)/2-e)*o,"px,").concat(((this.height-this.image.height)/2-i)*o,"px,0px)")}},{key:"cropByCircle",value:function(t){this.entry.keepRatio=t||this.keep,this.isCircle=t,this.preview.style.borderRadius=t?"50%":"",this._init()}},{key:"_init",value:function(){var t=this.image,e=this.copy;this.tools.style.width=this.entry.width,this.tools.style.height=this.entry.height;var i=this.isCircle?Math.min(this.tools.offsetWidth,this.tools.offsetHeight):0;this.props.w=i||this.tools.offsetWidth,this.props.h=i||this.tools.offsetHeight,this.tools.style.width=this.props.w+"px",this.tools.style.height=this.props.h+"px",this.props.x=(this.width-this.props.w)/2,this.props.y=(this.height-this.props.h)/2,this.ratio=this.props.w/this.props.h,this.entry.minHeight=this.entry.minWidth/this.ratio,this.tools.style.transform="translate3d(".concat(this.props.x,"px,").concat(this.props.y,"px,0px)"),this.circle.style.display=this.isCircle?"block":"none",t.width>=t.height?(t.width=this.width,e.width=this.previewBox.offsetWidth,t.removeAttribute("height"),e.removeAttribute("height")):(t.height=this.height,e.height=this.previewBox.offsetHeight,t.removeAttribute("width"),e.removeAttribute("width")),this.props.ix=(this.width-t.width)/2,this.props.iy=(this.height-t.height)/2,t.style.transform="translate3d(".concat(this.props.ix,"px,").concat(this.props.iy,"px,0px)"),this.previewCb(),this.svg[s.begin]=this.tools[s.begin]=this.adjustDms.bind(this)}},{key:"reset",value:function(){this.isCircle=this._circle,this._init()}},{key:"destroy",value:function(){this.svg[s.begin]=this.tools[s.begin]=this.inputFile.onchange=t=s=i=c=null}},{key:"update",value:function(e){var i=this;this.image.src=e,this.copy.src=e,this.image.onload=function(t){window.URL.revokeObjectURL(e),i.ok=!0,i._init()}}},{key:"_createElements",value:function(){var t=this.tools=document.createElement("div"),e=this.svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),i=this.image=new Image,s=this.circle=document.createElement("p"),h="box-shadow:rgba(0,0,0,.6) 0 0 0 ".concat(Math.max(this.width,this.height),"px");this.el.style.cssText='overflow: hidden;position: relative;background-image: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAAA3NCSVQICAjb4U/gAAAABlBMVEXMzMz////TjRV2AAAACXBIWXMAAArrAAAK6wGCiw1aAAAAHHRFWHRTb2Z0d2FyZQBBZG9iZSBGaXJld29ya3MgQ1M26LyyjAAAABFJREFUCJlj+M/AgBVhF/0PAH6/D/HkDxOGAAAAAElFTkSuQmCC");',t.title="移动选取框",t.style.cssText="position: absolute;cursor: move;z-index: 2;left: 0;top: 0;".concat(h),s.style.cssText="position: absolute;left: 0;top: 0;bottom: 0;right: 0;border-radius: 50%;margin: 0; z-index: -1;".concat(h),e.setAttribute("viewBox","0 0 1025 1024"),e.setAttribute("width","30"),e.setAttribute("height","30"),e.setAttribute("fill","#fff"),e.innerHTML='<title>调整大小</title><path d="M324.8 444.8 442.752 325.632 252.032 131.968 381.12 1.152 3.328 1.152 3.328 384.256 134.272 251.392 324.8 444.8Z"></path><path d="M1024.222643 634.624 885.248 768.832 691.136 573.44 570.752 693.824 765.248 889.408 637.504 1022.808589 1024.222643 1022.808589 1024.222643 634.624Z"></path>',this.svg.setAttribute("style","background-color: rgba(0, 0, 0, .5);position: absolute;z-index: 3;right: 0;bottom: 0;cursor: nwse-resize;padding: 2px;border:1px solid #666;"),this.previewBox.style.height=parseInt(getComputedStyle(this.previewBox,!1).width)*this.height/this.width+"px",this.preview=document.createElement("div"),this.preview.style.overflow="hidden";var o=this.copy=i.cloneNode(!0);this.preview.appendChild(o),this.previewBox.appendChild(this.preview),t.appendChild(e),t.appendChild(s),this.el.appendChild(i),this.el.appendChild(t)}},{key:"download",value:function(){this.getCroped().then(function(t){var e=document.createElement("a");e.download=t.name,e.href=t.url,e.click(),e=null})}}],[{key:"blobToBase64",value:function(t){return(new FileReader).readAsDataURL(t)}},{key:"base64ToBlob",value:function(t){for(var e=t.split(","),i=e[0].match(/:(.*?);/)[1],s=atob(e[1]),h=s.length,o=new Uint8Array(h);_readOnlyError("n"),h--;)o[h]=s.charCodeAt(h);return new Blob([o],{type:i})}}]),e}()});