!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t=t||self).Crop=i()}(this,function(){"use strict";var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)i.hasOwnProperty(e)&&(t[e]=i[e])})(t,i)};var t,i,s,o=function(){return(o=Object.assign||function(t){for(var i,e=1,s=arguments.length;e<s;e++)for(var h in i=arguments[e])Object.prototype.hasOwnProperty.call(i,h)&&(t[h]=i[h]);return t}).apply(this,arguments)},h=window.URL||window.webkitURL,n="ontouchend"in document,m={end:n?"ontouchend":"onmouseup",move:n?"ontouchmove":"onmousemove",begin:n?"ontouchstart":"onmousedown"},d=function(t,i,e){return Math.min(Math.max(t,i),e)},r=new FileReader,p=(l.prototype.$=function(t,i){return(i||document).querySelector(t)},l.prototype.$c=function(t){return document.createElement(t)},l.prototype.init=function(){this.cfg.circle&&(this.cfg.keepPP=!0),this.render(),this.bindFileEvt(),this.mk[m.begin]=this.bindEvt.bind(this)},l.prototype.render=function(){this.mk=this.$c("div"),this.view.style.cssText="font-size:0;position:relative;overflow:hidden",this.img=this.$c("img"),this.img.draggable=!1,this.img.crossOrigin="",this.img.style.visibility="hidden",this.mk.style.cssText="visibility:hidden;touch-action:none;position: absolute;width:"+this.cfg.maskWidth+";height:"+this.cfg.maskHeight+";left:0;top:0;box-shadow:rgba(0,0,0,.7) 0 0 0 "+(this.vw+50)+"px",this.view.appendChild(this.img),this.view.appendChild(this.mk),this.mk.innerHTML+='<div style="box-sizing:border-box;border:1px dashed #39f;height:100%"></div><svg id="c_c" style="position: absolute;right:-10px;bottom: -10px;touch-action:none" width="30" height="30" xmlns="http://www.w3.org/2000/svg"><rect style="pointer-events:none" x="10" y = "10" width = "10" height = "10" fill = "#39f" /></svg></div>',this.dot=this.$("svg",this.mk)},l.prototype.bindFileEvt=function(){this.file&&(this.file.accept="image/jpeg,image/png,image/webp,image/gif",this.file.onchange=this.fileEvt.bind(this))},l.prototype.fileEvt=function(){var i=this,t=this.file.files[0];if(this.file.value="",-1===t.type.indexOf("image"))this.cfg.error(0);else{if(t.size>this.cfg.size)return this.cfg.error(1);h?this.loadImage(h.createObjectURL(t)):(r.readAsDataURL(t),r.onload=function(t){i.loadImage(t.target.result)})}},l.prototype.loadImage=function(t,i){var e=this;this.img.src=t,this.img.onerror=function(){return e.cfg.error(2)},this.img.onload=function(){return e.loaded(i)}},l.prototype.loaded=function(t){var i=this.img.naturalWidth,e=this.img.naturalHeight,s=this.mk.offsetWidth,h=this.mk.offsetHeight;if(this.mk.style.visibility="",this.mp={w:s,h:h},this.kp=s/h,this.cfg.circle){var n=Math.min(s,h);this.resizeDiv(n,n),this.mk.style.borderRadius="50%"}this.pmt=Math.min(this.vw/i,this.vh/e),this.img.width=i*this.pmt,this.img.height=e*this.pmt,this.img.style.visibility="",this.ip={l:(this.vw-this.img.width)/2,t:(this.vh-this.img.height)/2,w:i,h:e},this.img.style.transform="translate3d("+this.ip.l+"px,"+this.ip.t+"px,0)",this.moveDiv((this.vw-s)/2,(this.vh-h)/2),this.rsp=o({},this.mp),this.cfg.onload()},l.prototype.bindEvt=function(t){var n,o,r=this,i=this.mp,p=i.w,l=i.h,a=i.l,c=i.t,f="c_c"!==t.srcElement.id;document[m.move]=function(t){t.preventDefault();var i=t.pageX||t.touches[0].pageX,e=t.pageY||t.touches[0].pageY,s=r.vw,h=r.vh;n||(n=i,o=e),f?r.moveDiv(r.mp.l=d(a+i-n,0,s-p),r.mp.t=d(c+e-o,0,h-l)):r.resizeDiv(d(p+i-n,r.cfg.minWidth,s-a),d(l+e-o,r.cfg.minHeight,h-c)),r.cfg.isEnd||r.pc()},document[m.end]=function(){document[m.move]=document[m.end]=null,r.cfg.isEnd&&r.pc()}},l.prototype.pc=function(){},l.prototype.loadpre=function(){},l.prototype.resizeDiv=function(t,i){this.cfg.keepPP&&(1<this.kp?i=t/this.kp:t=i*this.kp),this.mp.w=t,this.mp.h=i,this.mk.style.width=t+"px",this.mk.style.height=i+"px"},l.prototype.moveDiv=function(t,i){this.mp.l=t,this.mp.t=i,this.mk.style.transform="translate3d("+t+"px,"+i+"px,0px)"},l.prototype.cropped=function(){if(!this.img.src)return this.cfg.error(3);var t=this.cfg,i=this.$c("canvas"),e=i.getContext("2d"),s=this.mp,h=s.w,n=s.h,o=s.l,r=s.t,p=this.cfg.outmax,l=Math.min(p/h,p/n);i.width=0<p?h*l:h/this.pmt,i.height=0<p?n*l:n/this.pmt;var a=[i.width,i.height],c=a[0],f=a[1];-1!==t.type.indexOf("jpeg")&&(e.fillStyle="#fff",e.fillRect(0,0,c,f)),t.circle&&(e.arc(c/2,f/2,c/2,0,2*Math.PI),e.clip());var m=o-this.ip.l,d=r-this.ip.t,g=m/this.pmt,v=d/this.pmt;return e.drawImage(this.img,Math.max(0,g),Math.max(0,v),h/this.pmt,n/this.pmt,-Math.min(m,0)*c/h,-Math.min(d,0)*f/h,c,f),function(t,i){for(var e=i.getImageData(0,0,t.width,t.height).data,s=e.length,h=0;h<s;h++)if(255!==e[h]&&0!==e[h])return!1;return!0}(i,e)?t.error(3):this.export(i,t)},l.prototype.export=function(t,i){var e="image/"+i.type,s=i.quality/100;return i.blob?new Promise(function(i){t.toBlob(function(t){return i(t)},e,s)}):t.toDataURL(e,s)},l.prototype.reset=function(){if(this.rsp){var t=this.rsp,i=t.w,e=t.h,s=t.l,h=t.t;this.moveDiv(s,h),this.resizeDiv(i,e),this.pc()}},l.prototype.resetAll=function(){this.reset(),this.mk.style.visibility=this.img.style.visibility="hidden"},l.prototype.clear=function(){h.revokeObjectURL(this.img.src),this.img.removeEventListener("load",this.loadpre,!1),this.file&&(this.file.onchange=null),this.cropped=this.reset=this.mk[m.begin]=m=d=r=HTMLImageElement.prototype.ready=this.img.onerror=null},l);function l(t){this.cfg={size:5242880,maskWidth:"60%",maskHeight:"60%",minWidth:100,minHeight:100,outmax:0,keepPP:!0,isEnd:!0,quality:100,type:"png",error:function(){},onload:function(){}},this.cfg=o({},this.cfg,t),this.view="string"==typeof t.view?this.$(t.view):t.view,this.file="string"==typeof t.file?this.$(t.file):t.file,this.vw=this.view.offsetWidth,this.vh=this.view.offsetHeight,this.init()}function a(){this.constructor=t}function c(t){var i=s.call(this,t)||this;return i.pv="string"==typeof t.preview?i.$(t.preview):t.preview,i.rp(),i}return e(t=c,i=s=p),void(t.prototype=null===i?Object.create(i):(a.prototype=i.prototype,new a)),c.prototype.rp=function(){this.in=this.$c("div"),this.in.style.cssText="visibility:hidden;font-size:0;overflow:hidden;"+(this.cfg.circle?"border-radius:50%":""),this.pv.appendChild(this.in);var t=this.pv.offsetWidth;this.pp={w:t,h:t/this.vw*this.vh},this.pv.style.cssText="position:relative;overflow:hidden;height:"+this.pp.h+"px",this.img.addEventListener("load",this.loadpre.bind(this))},c.prototype.loadpre=function(){var i=this;setTimeout(function(){var t=i.img.cloneNode();t.style.transformOrigin="left top",i.pi?i.in.replaceChild(t,i.pi):i.in.appendChild(t),i.pi=t,i.pc(),i.in.style.visibility=""})},c.prototype.pc=function(){var t=1/Math.max(this.mp.w/this.pp.w,this.mp.h/this.pp.h);this.pi.style.transform="translate3d("+(this.ip.l-this.mp.l)+"px,"+(this.ip.t-this.mp.t)+"px,0)",this.in.style.width=this.mp.w+"px",this.in.style.height=this.mp.h+"px",this.in.style.transform="scale("+t+") translate3d("+(this.pp.w-this.mp.w)/2/t+"px,"+(this.pp.h-this.mp.h)/2/t+"px,0)"},c.prototype.resetAll=function(){this.reset(),this.mk.style.visibility=this.img.style.visibility=this.in.style.visibility="hidden"},c});
