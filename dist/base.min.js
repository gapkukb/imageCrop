!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t=t||self).Crop=i()}(this,function(){"use strict";function i(t,i){return(i||document).querySelector(t)}var o=function(){return(o=Object.assign||function(t){for(var i,e=1,h=arguments.length;e<h;e++)for(var s in i=arguments[e])Object.prototype.hasOwnProperty.call(i,s)&&(t[s]=i[s]);return t}).apply(this,arguments)},e=window.URL||window.webkitURL,t="ontouchend"in document,h={end:t?"ontouchend":"onmouseup",move:t?"ontouchmove":"onmousemove",begin:t?"ontouchstart":"onmousedown"},l=function(t,i,e){return Math.min(Math.max(t,i),e)},s=new FileReader;function n(t){this.cfg={size:5242880,maskWidth:"60%",maskHeight:"60%",minWidth:100,minHeight:100,outWidth:0,outHeight:0,keepPP:!0,event:"end",quality:100,error:function(){}},this.cfg=o({},this.cfg,t),this.view=i(t.view),this.file=i(t.file),this.init()}return n.prototype.init=function(){this.vw=this.view.offsetWidth,this.vh=this.view.offsetHeight,this.cfg.circle&&(this.cfg.keepPP=!0),this.render(),this.bindFileEvt(),this.mk[h.begin]=this.bindEvt.bind(this)},n.prototype.render=function(){this.mk=document.createElement("div"),this.view.style.cssText="font-size:0;position:relative;overflow:hidden",this.img=new Image,this.img.draggable=!1,this.img.crossOrigin="",this.mk.style.cssText="visibility:hidden;touch-action:none;position: absolute;width:"+this.cfg.maskWidth+";height:"+this.cfg.maskHeight+";left:0;top:0;box-shadow:rgba(0,0,0,.7) 0 0 0 "+(this.vw+50)+"px",this.view.appendChild(this.img),this.view.appendChild(this.mk),this.mk.innerHTML+='<div style="box-sizing:border-box;border:1px dashed #39f;height:100%"></div><svg id="c_c" style="position: absolute;right:-10px;bottom: -12px;touch-action:none" width="30" height="30" xmlns="http://www.w3.org/2000/svg"><rect style="pointer-events:none" x="10" y = "10" width = "10" height = "10" fill = "#39f" /></svg></div>',this.dot=i("svg",this.mk)},n.prototype.bindFileEvt=function(){this.file&&(this.file.accept="image/jpeg,image/png,image/webp,image/gif",this.file.onchange=this.fileEvt.bind(this))},n.prototype.fileEvt=function(){var i=this,t=this.file.files[0];if(this.file.value="",-1===t.type.indexOf("image"))this.cfg.error(0);else{if(t.size>this.cfg.size)return this.cfg.error(1);e?this.loadImage(e.createObjectURL(t)):(s.readAsDataURL(t),s.onload=function(t){i.loadImage(t.target.result)})}},n.prototype.loadImage=function(t,i){var e=this;this.img.src=t,this.img.onerror=this.cfg.error.call(null,2),this.img.onload=function(){return e.loaded(i)}},n.prototype.loaded=function(t){var i=this.img.naturalWidth,e=this.img.naturalHeight,h=this.mk.offsetWidth,s=this.mk.offsetHeight;if(this.mk.style.visibility="",this.mp={w:h,h:s},this.kp=h/s,this.cfg.circle){var n=Math.min(h,s);this.resizeDiv(n,n),this.mk.style.borderRadius="50%"}this.pmt=Math.min(this.vw/i,this.vh/e),this.img.width=i*this.pmt,this.img.height=e*this.pmt,this.ip={l:(this.vw-this.img.width)/2,t:(this.vh-this.img.height)/2,w:i,h:e},this.img.style.transform="translate3d("+this.ip.l+"px,"+this.ip.t+"px,0)",this.moveDiv((this.vw-h)/2,(this.vh-s)/2),this.rp=o({},this.mp)},n.prototype.bindEvt=function(t){var n,o,r=this,i=this.mp,a=i.w,m=i.h,p=i.l,c=i.t,d="c_c"!==t.srcElement.id;document[h.move]=function(t){t.preventDefault();var i=t.pageX||t.touches[0].pageX,e=t.pageY||t.touches[0].pageY,h=r.vw,s=r.vh;n||(n=i,o=e),d?r.moveDiv(r.mp.l=l(p+i-n,0,h-a),r.mp.t=l(c+e-o,0,s-m)):r.resizeDiv(l(a+i-n,r.cfg.minWidth,h-p),l(m+e-o,r.cfg.minHeight,s-c))},document[h.end]=function(){document[h.move]=document[h.end]=null}},n.prototype.resizeDiv=function(t,i){this.cfg.keepPP&&(1<this.kp?i=t/this.kp:t=i*this.kp),this.mp.w=t,this.mp.h=i,this.mk.style.width=t+"px",this.mk.style.height=i+"px"},n.prototype.moveDiv=function(t,i){this.mp.l=t,this.mp.t=i,this.mk.style.transform="translate3d("+t+"px,"+i+"px,0px)"},n.prototype.cropped=function(){var t=this.cfg,i=document.createElement("canvas"),e=i.getContext("2d"),h=this.mp,s=h.w,n=h.h,o=h.l,r=h.t,a=Math.max(t.outWidth,t.outHeight),m=Math.min(a/s,a/n);i.width=0<a?s*m:n/this.pmt,i.height=0<a?n*m:n/this.pmt;var p=[i.width,i.height],c=p[0],d=p[1];-1!==t.ext.indexOf("jpg")&&(e.fillStyle="#fff",e.fillRect(0,0,c,d)),t.circle&&(e.arc(c/2,d/2,c/2,0,2*Math.PI),e.clip());var l=o-this.ip.l,g=r-this.ip.t,f=l/this.pmt,u=g/this.pmt;if(e.drawImage(this.img,Math.max(0,f),Math.max(0,u),s/this.pmt,n/this.pmt,-Math.min(l,0)*c/s,-Math.min(g,0)*d/s,c,d),function(t,i){for(var e=i.getImageData(0,0,t.width,t.height).data,h=e.length,s=0;s<h;s++)if(255!==e[s]&&0!==e[s])return!1;return!0}(i,e))return t.error(3);var v=i.toDataURL("image/"+t.ext,t.quality/100);i=e=null;var w=new Image;return w.src=v,document.body.appendChild(w),v},n.prototype.reset=function(){var t=this.rp,i=t.w,e=t.h,h=t.l,s=t.t;this.moveDiv(h,s),this.resizeDiv(i,e)},n.prototype.clear=function(){e.revokeObjectURL(this.img.src),clearTimeout(this.t),this.file.onchange=this.mk[h.begin]=h=l=s=HTMLImageElement.prototype.ready=this.img.onerror=null},n});
